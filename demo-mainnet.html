<!DOCTYPE html>
<html>
<head>
</head>
<body>
    <h1>Step 1</h1>
    <p>Generate your linking key</p>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bitcoinaudible.com/wp-content/plugins/lnlogin/js/qrcode.js"></script>
    <div style="border: 1px solid black; margin: auto; max-width: 800px; width: 100%; display: block; height: 300px; overflow: scroll;">
        <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
        <script src="https://bundle.run/buffer@6.0.3"></script>

        <p style="font-weight: bold;" id="email_instructions_label">Email Instructions</p>
        <p id="email_instructions">Enter an email. You're not sending us your email, this page will just put it in the template code that you'll add to your website. (For purposes of this demo, the result of running the template code will be displayed in the box in Step 2.) An email is required so that people can send you your whisper key when they give you money. If you don't get the whisper key, you can't recover the money.</p>
        <p style="font-weight: bold; display: none;" id="linking_label">Your linking key</p>
        <input type="text" id="linking_key" style="color: black; display: none;" value="Example" disabled>
        <p style="font-weight: bold; display: none;" id="key_instructions_label">Linking Key Instructions</p>
        <p style="display: none;" id="key_instructions">Make sure to save your linking key. Write it down or print it or similar. You will need it later to recover your bitcoins.</p>
        <p style="font-weight: bold;" id="email_label">Your email address</p>
        <input type="text" id="email" style="color: black;" placeholder="johnsmith@example.com">
        <p><button type="button" id="submitter">Submit</button></p>
        <p style="font-weight: bold; display: none;" id="code_label">Code to add to your website</p>
        <pre id="final_code" style="white-space: pre-wrap; word-wrap: break-word; background-color:  #ccc; padding: 5px; border: 1px solid black; display: none;"></pre>
        <p style="font-weight: bold; display: none;" id="code_instructions_label">Code Instructions</p>
        <p style="display: none;" id="code_instructions">Add the block of code above to any page of your website. Visitors to your page will see a "whisper address" -- a bitcoin address that only you can recover funds from. They will also see a whisper key which they need to send you in order for you to recover money from that bitcoin address.</p>
        <script>
            document.getElementById( "submitter" ).addEventListener( "click", function() {
                var tags = 'PGRpdiBpZD0id2hpc3Blcl9hZGRyZXNzIj4gPHNjcmlwdCBzcmM9Imh0dHBzOi8vYml0Y29pbmNvcmUudGVjaC9hcHBzL2JpdGNvaW5qcy11aS9saWIvYml0Y29pbmpzLWxpYi5qcyI+PC9zY3JpcHQ+PHNjcmlwdCBzcmM9Imh0dHBzOi8vYnVuZGxlLnJ1bi9idWZmZXJANi4wLjMiPjwvc2NyaXB0PjxzY3JpcHQgc3JjPSJodHRwczovL2J1bmRsZS5ydW4vbm9ibGUtc2VjcDI1NmsxQDEuMi4xNCI+PC9zY3JpcHQ+PHNjcmlwdCBzcmM9Imh0dHBzOi8vYml0Y29pbmF1ZGlibGUuY29tL3dwLWNvbnRlbnQvcGx1Z2lucy9sbmxvZ2luL2pzL3FyY29kZS5qcyI+PC9zY3JpcHQ+IDxzY3JpcHQ+IHZhciBsaW5raW5nX3B1YmtleSA9ICJhYWFhYWFhYWFhIjsgZnVuY3Rpb24gZ2V0Q29tcHJlc3NlZFB1YmtleUhleEZyb21Qcml2a2V5SGV4KCBwcml2a2V5aGV4ICkgeyByZXR1cm4gYml0Y29pbmpzLkVDUGFpci5mcm9tUHJpdmF0ZUtleSggYnVmZmVyLkJ1ZmZlci5mcm9tKCBwcml2a2V5aGV4LCAiaGV4IiApLCB7IG5ldHdvcms6IGJpdGNvaW5qcy5uZXR3b3Jrcy5tYWlubmV0IH0gKS5wdWJsaWNLZXkudG9TdHJpbmcoICJoZXgiICk7IH0gZnVuY3Rpb24gYWRkMlB1YmtleXMoIHB1YmtleTEsIHB1YmtleTIgKSB7IHJldHVybiBub2JsZVNlY3AyNTZrMS5Qb2ludC5mcm9tSGV4KCBwdWJrZXkxICkuYWRkKCBub2JsZVNlY3AyNTZrMS5Qb2ludC5mcm9tSGV4KCBwdWJrZXkyICkgKS50b0hleCgpOyB9IGZ1bmN0aW9uIGdldENvbXByZXNzZWRQdWJrZXlIZXhGcm9tVW5jb21wcmVzc2VkUHVia2V5SGV4KCBwdWJrZXloZXggKSB7IHJldHVybiBiaXRjb2luanMuRUNQYWlyLmZyb21QdWJsaWNLZXkoIGJ1ZmZlci5CdWZmZXIuZnJvbSggcHVia2V5aGV4LCAiaGV4IiApICkucHVibGljS2V5LnRvU3RyaW5nKCAiaGV4IiApOyB9IGZ1bmN0aW9uIGdldE5hdGl2ZVNlZ3dpdEFkZHJlc3NGcm9tUHVia2V5SGV4KCBwdWJrZXloZXggKSB7IHJldHVybiBiaXRjb2luanMucGF5bWVudHMucDJ3cGtoKHsgcHVia2V5OiBidWZmZXIuQnVmZmVyLmZyb20oIHB1YmtleWhleCwgImhleCIgKSwgbmV0d29yazogYml0Y29pbmpzLm5ldHdvcmtzLm1haW5uZXQgfSkuYWRkcmVzczsgfSBmdW5jdGlvbiBtYWtlU21hbGxQcml2a2V5KCkgeyB2YXIgcmFuZCA9IG5ldyBVaW50OEFycmF5KCAzMiApOyB2YXIgcHJpdmtleSA9IGJ1ZmZlci5CdWZmZXIuZnJvbSggd2luZG93LmNyeXB0by5nZXRSYW5kb21WYWx1ZXMoIHJhbmQgKSApLnRvU3RyaW5nKCAiaGV4IiApOyBpZiAoIHByaXZrZXkuc3Vic3RyaW5nKCAwLCAxICkgIT0gJzAnIHx8IHByaXZrZXkuc3Vic3RyaW5nKCAxLCAyICkgIT0gJzAnICkgeyByZXR1cm4gbWFrZVNtYWxsUHJpdmtleSgpIH0gcmV0dXJuIHByaXZrZXk7IH0gZnVuY3Rpb24gY3JlYXRlUVIoIGNvbnRlbnQgKSB7IHZhciBkYXRhVXJpUG5nSW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW1nIiApLCBzID0gUVJDb2RlLmdlbmVyYXRlUE5HKCBjb250ZW50LCB7IGVjY2xldmVsOiAiTSIsIGZvcm1hdDogImh0bWwiLCBmaWxsY29sb3I6ICIjRkZGRkZGIiwgdGV4dGNvbG9yOiAiIzM3MzczNyIsIG1hcmdpbjogNCwgbW9kdWxlc2l6ZTogOCB9KTsgZGF0YVVyaVBuZ0ltYWdlLnNyYyA9IHM7IGRhdGFVcmlQbmdJbWFnZS5pZCA9ICJxcl9jb2RlIjsgcmV0dXJuIGRhdGFVcmlQbmdJbWFnZTsgfSB2YXIgd2hpc3Blcl9rZXkgPSBtYWtlU21hbGxQcml2a2V5KCk7IHZhciB3aGlzcGVyX3B1YmtleSA9IGdldENvbXByZXNzZWRQdWJrZXlIZXhGcm9tUHJpdmtleUhleCggd2hpc3Blcl9rZXkgKTsgdmFyIGNvbWJva2V5ID0gZ2V0Q29tcHJlc3NlZFB1YmtleUhleEZyb21VbmNvbXByZXNzZWRQdWJrZXlIZXgoIGFkZDJQdWJrZXlzKCBsaW5raW5nX3B1YmtleSwgd2hpc3Blcl9wdWJrZXkgKSApOyB2YXIgd2hpc3Blcl9hZGRyZXNzID0gZ2V0TmF0aXZlU2Vnd2l0QWRkcmVzc0Zyb21QdWJrZXlIZXgoIGNvbWJva2V5ICk7IGNvbnNvbGUubG9nKCB3aGlzcGVyX2FkZHJlc3MgKTsgdmFyIGFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOyBhbmNob3IuaHJlZiA9ICJiaXRjb2luOiIgKyB3aGlzcGVyX2FkZHJlc3M7IGFuY2hvci5hcHBlbmRDaGlsZCggY3JlYXRlUVIoIHdoaXNwZXJfYWRkcmVzcyApICk7IHZhciBodG1sID0gIiI7IGh0bWwgKz0gIjxwPkJpdGNvaW4gYWRkcmVzczogIiArIHdoaXNwZXJfYWRkcmVzcyArICI8L3A+IjsgaHRtbCArPSAiPHA+V2hpc3BlciBrZXk6ICIgKyB3aGlzcGVyX2tleSArICI8L3A+IjsgaHRtbCArPSAnPHAgc3R5bGU9ImZvbnQtd2VpZ2h0OiBib2xkOyI+SW5zdHJ1Y3Rpb25zPC9wPic7IGh0bWwgKz0gIjxwPldBUk5JTkc6IFRoaXMgaXMgYWR2YW5jZWQgY3J5cHRvZ3JhcGh5LiBZb3UgV0lMTCBsb3NlIHlvdXIgbW9uZXkgaWYgeW91IGRvbid0IGZvbGxvdyB0aGVzZSBpbnN0cnVjdGlvbnMgRVhBQ1RMWS48L3A+IjsgaHRtbCArPSAiPHA+VGhlIGJpdGNvaW4gYWRkcmVzcyBhYm92ZSBpcyBhIHByaXZhdGUgdHlwZSBvZiBiaXRjb2luIGFkZHJlc3MgY2FsbGVkIGEgd2hpc3BlciBhZGRyZXNzLiBUaGUgcmVjaXBpZW50IHdpbGwgbm90IHJlY2VpdmUgdGhlIG1vbmV5IHVubGVzcyB5b3UgZW1haWwgaGltIHNvbWV0aGluZyBjYWxsZWQgYSB3aGlzcGVyIGtleSwgd2hpY2ggaXMgZGlzcGxheWVkIGJlbG93IHRoZSBhZGRyZXNzLjwvcD4iOyBodG1sICs9ICI8cD5GSVJTVCBzZW5kIHNvbWUgYml0Y29pbnMgdG8gdGhlIGJpdGNvaW4gYWRkcmVzcywgVEhFTiAtLSBXSVRIT1VUIFJFRlJFU0hJTkcgLS0gc2VuZCB0aGUgcmVjaXBpZW50IHRoZSB3aGlzcGVyIGtleS4gSWYgeW91IHJlZnJlc2ggdGhlIHBhZ2UgYWZ0ZXIgeW91IHNlbnQgdGhlIGJpdGNvaW5zIGJ1dCBiZWZvcmUgeW91IHNlbnQgdGhlIHdoaXNwZXIga2V5LCB0aGUgYml0Y29pbnMgd2lsbCBiZSBsb3N0IGZvcmV2ZXIgYW5kIHRoZSByZWNpcGllbnQgd2lsbCBuZXZlciByZWNvdmVyIGl0LjwvcD4iOyBodG1sICs9ICI8cD5UaGUgYnV0dG9uIGJlbG93IHdpbGwgbGV0IHlvdSBlYXNpbHkgc2VuZCBhbiBlbWFpbCB0byB0aGUgcmVjaXBpZW50IHdpdGggaGlzIHdoaXNwZXIga2V5LiBETyBOT1QgY2xpY2sgaXQgdW50aWwgYWZ0ZXIgeW91IHNlbnQgdGhlIG1vbmV5LiBNQUtFIFNVUkUgdGhlIHdoaXNwZXIga2V5IGluIHRoZSBlbWFpbCBtYXRjaGVzIHRoZSB3aGlzcGVyIGtleSB1bmRlciB0aGUgYml0Y29pbiBhZGRyZXNzLjwvcD4iOyBodG1sICs9ICI8cD5BZ2FpbiwgUkVGUkVTSElORyBUSElTIFBBR0UgSVMgVkVSWSBEQU5HRVJPVVMuIEV2ZXJ5IHRpbWUgeW91IHJlZnJlc2gsIHRoZSBiaXRjb2luIGFkZHJlc3Mgd2lsbCBjaGFuZ2UuIElmIHlvdSBoYXZlbid0IHNlbnQgb3V0IHRoZSB3aGlzcGVyIGtleSBhbmQgeW91IHJlZnJlc2gsIHlvdSB3aWxsIG5ldmVyIHNlZSB0aGUgd2hpc3BlciBrZXkgYWdhaW4gYW5kIHRoZSBiaXRjb2lucyB3aWxsIGJlIGxvc3QgZm9yZXZlci4gQkUgQ0FSRUZVTC48L3A+IjsgdmFyIG1haWx0byA9ICJtYWlsdG86YmJiYmJiYmJiYj9zdWJqZWN0PVNvbWVvbmUgc2VudCB5b3UgbW9uZXkmYm9keT1Zb3UgcmVjZWl2ZWQgbW9uZXkgaW50byB5b3VyIHdoaXNwZXIgYWRkcmVzcy4lMEQlMEElMEQlMEFUaGUgd2hpc3BlciBrZXkgaXMgIiArIHdoaXNwZXJfa2V5ICsgIiUwRCUwQSUwRCUwQUdvIGhlcmUgdG8gcmVkZWVtIGl0OiBodHRwczovL3N1cGVydGVzdG5ldC5naXRodWIuaW8vd2hpc3Blci1hZGRyZXNzZXMvd2l0aGRyYXctZnJvbS1hLXdoaXNwZXItYWRkcmVzcy5odG1sIjsgaHRtbCArPSAiPGEgb25jbGljaz0nd2luZG93Lm9wZW4oIG1haWx0byApJz48YnV0dG9uPlNlbmQgZW1haWw8L2J1dHRvbj4iOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggIndoaXNwZXJfYWRkcmVzcyIgKS5hcHBlbmRDaGlsZCggYW5jaG9yICk7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCAid2hpc3Blcl9hZGRyZXNzIiApLmlubmVySFRNTCArPSBodG1sOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggIndoaXNwZXJfYWRkcmVzcyIgKS5zdHlsZS50ZXh0QWxpZ24gPSAiY2VudGVyIjsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoICJ3aGlzcGVyX2FkZHJlc3MiICkuc3R5bGUubWF4V2lkdGggPSAiODAwcHgiOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggIndoaXNwZXJfYWRkcmVzcyIgKS5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkIGJsYWNrIjsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoICJ3aGlzcGVyX2FkZHJlc3MiICkuc3R5bGUucGFkZGluZyA9ICIxMHB4IjsgPC9zY3JpcHQ+IDwvZGl2Pg==';
                var privkey = makeSmallPrivkey();
                var pubkey = getCompressedPubkeyHexFromPrivkeyHex( privkey );
                var html = atob( tags ).replace( "aaaaaaaaaa", pubkey ).replace( "bbbbbbbbbb", document.getElementById( "email" ).value );
                document.getElementById( "email_instructions_label" ).style.display = "none";
                document.getElementById( "email_instructions" ).style.display = "none";
                document.getElementById( "linking_key" ).value = privkey;
                document.getElementById( "linking_label" ).style.display = "block";
                document.getElementById( "linking_key" ).style.display = "block";
                document.getElementById( "code_label" ).style.display = "block";
                document.getElementById( "final_code" ).style.display = "block";
                document.getElementById( "final_code" ).append( html );
                document.getElementById( "email_label" ).style.display = "none";
                document.getElementById( "email" ).style.display = "none";
                document.getElementById( "submitter" ).style.display = "none";
                document.getElementById( "key_instructions_label" ).style.display = "block";
                document.getElementById( "key_instructions" ).style.display = "block";
                document.getElementById( "code_instructions_label" ).style.display = "block";
                document.getElementById( "code_instructions" ).style.display = "block";
                var linking_pubkey = pubkey; function getCompressedPubkeyHexFromPrivkeyHex( privkeyhex ) { return bitcoinjs.ECPair.fromPrivateKey( buffer.Buffer.from( privkeyhex, "hex" ), { network: bitcoinjs.networks.mainnet } ).publicKey.toString( "hex" ); } function add2Pubkeys( pubkey1, pubkey2 ) { return nobleSecp256k1.Point.fromHex( pubkey1 ).add( nobleSecp256k1.Point.fromHex( pubkey2 ) ).toHex(); } function getCompressedPubkeyHexFromUncompressedPubkeyHex( pubkeyhex ) { return bitcoinjs.ECPair.fromPublicKey( buffer.Buffer.from( pubkeyhex, "hex" ) ).publicKey.toString( "hex" ); } function getNativeSegwitAddressFromPubkeyHex( pubkeyhex ) { return bitcoinjs.payments.p2wpkh({ pubkey: buffer.Buffer.from( pubkeyhex, "hex" ), network: bitcoinjs.networks.mainnet }).address; } function makeSmallPrivkey() { var rand = new Uint8Array( 32 ); var privkey = buffer.Buffer.from( window.crypto.getRandomValues( rand ) ).toString( "hex" ); if ( privkey.substring( 0, 1 ) != '0' || privkey.substring( 1, 2 ) != '0' ) { return makeSmallPrivkey() } return privkey; } function createQR( content ) { var dataUriPngImage = document.createElement( "img" ), s = QRCode.generatePNG( content, { ecclevel: "M", format: "html", fillcolor: "#FFFFFF", textcolor: "#373737", margin: 4, modulesize: 8 }); dataUriPngImage.src = s; dataUriPngImage.id = "qr_code"; return dataUriPngImage; } var whisper_key = makeSmallPrivkey(); var whisper_pubkey = getCompressedPubkeyHexFromPrivkeyHex( whisper_key ); var combokey = getCompressedPubkeyHexFromUncompressedPubkeyHex( add2Pubkeys( linking_pubkey, whisper_pubkey ) ); var whisper_address = getNativeSegwitAddressFromPubkeyHex( combokey ); console.log( whisper_address ); var anchor = document.createElement( "a" ); anchor.href = "bitcoin:" + whisper_address; anchor.appendChild( createQR( whisper_address ) ); var html = ""; html += "<p>Bitcoin address: " + whisper_address + "</p>"; html += "<p>Whisper key: " + whisper_key + "</p>"; html += '<p style="font-weight: bold;">Instructions</p>'; html += "<p>WARNING: This is advanced cryptography. You WILL lose your money if you don't follow these instructions EXACTLY.</p>"; html += "<p>The bitcoin address above is a private type of bitcoin address called a whisper address. The recipient will not receive the money unless you email him something called a whisper key, which is displayed below the address.</p>"; html += "<p>FIRST send some bitcoins to the bitcoin address, THEN -- WITHOUT REFRESHING -- send the recipient the whisper key. If you refresh the page after you sent the bitcoins but before you sent the whisper key, the bitcoins will be lost forever and the recipient will never recover it.</p>"; html += "<p>The email below will let you easily send an email to the recipient with his whisper key. DO NOT click it until after you sent the money. MAKE SURE the whisper key in the email matches the whisper key under the bitcoin address.</p>"; html += "<p>Again, REFRESHING THIS PAGE IS VERY DANGEROUS. Every time you refresh, the bitcoin address will change. If you haven't sent out the whisper key and you refresh, you will never see the whisper key again and the bitcoins will be lost forever. BE CAREFUL.</p>"; var mailto = "mailto:" + document.getElementById( "email" ).value + "?subject=Someone sent you money&body=You received money into your whisper address.%0D%0A%0D%0AThe whisper key is " + whisper_key + "%0D%0A%0D%0AGo here to redeem it: https://supertestnet.github.io/whisper-addresses/withdraw-from-a-whisper-address-mainnet.html"; html += "<a onclick='window.open( mailto )'><button>Send email</button>"; document.getElementById( "code_demo" ).innerHTML = ""; document.getElementById( "code_demo" ).appendChild( anchor ); document.getElementById( "code_demo" ).innerHTML += html; document.getElementById( "code_demo" ).style.textAlign = "center"; document.getElementById( "code_demo" ).style.maxWidth = "800px"; document.getElementById( "code_demo" ).style.border = "1px solid black"; document.getElementById( "code_demo" ).style.padding = "10px";
            });

            function getCompressedPubkeyHexFromPrivkeyHex( privkeyhex ) {
                return bitcoinjs.ECPair.fromPrivateKey( buffer.Buffer.from( privkeyhex, "hex" ), { network: bitcoinjs.networks.mainnet } ).publicKey.toString( "hex" );
            }
            function makeSmallPrivkey() {
                var rand = new Uint8Array( 32 );
                var privkey = buffer.Buffer.from( window.crypto.getRandomValues( rand ) ).toString( "hex" );
                if ( privkey.substring( 0, 1 ) != '0' || privkey.substring( 1, 2 ) != '0' ) {
                        return makeSmallPrivkey()
                }
                return privkey;
            }        
        </script>
    </div>
    <h1>Step 2</h1>
    <p>Put your linking key and some javascript on your website so people can send you money. This is what the visitor to your website will see:</p>
    <div id="code_demo" style="border: 1px solid black; margin: auto; max-width: 800px; width: 100%; display: block; height: 300px; overflow: scroll;">
        {Nothing here yet, make a linking key first}
    </div>
    <h1>Step 3</h1>
    <p>Withdraw the money from your whisper addresses</p>
    <iframe style="border: 1px solid black; margin: auto; max-width: 800px; width: 100%; display: block; height: 300px" src="https://supertestnet.github.io/whisper-addresses/withdraw-from-a-whisper-address-mainnet.html">
</body>
</html>
